{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Куда пойти — Москва глазами Артёма</title>

  <link rel="shortcut icon" href="{% static 'afisha/favicon.png' %}" type="image/png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
  <link rel="stylesheet" href="{% static 'afisha/leaflet-sidebar.css' %}"/>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <style>
    body {
      padding: 0;
      margin: 0;
    }

    html, body, #map {
      height: 100%;
    }

    .place-description img {
      max-width: 100%;
    }

    .sidebar-content {
      padding: 14px 20px;
      height: 100%;
    }
    .select-place-prompt{
      color: red;
      width: 100px;
    }
  </style>
  {{ geo_script|json_script:"places-geojson" }}

</head>
<body>
  <div id="sidebar">
    <div id="sidebar-app" v-bind:class="{'sidebar-content': 1, 'bg-white': selectedPlace, 'bg-secondary': !selectedPlace}">

      <div v-if="promptVisible" class="d-flex flex-column justify-content-center align-items-center" style="height: 100%;">
        <img class="d-block select-place-prompt mb-4" src="{%  static 'afisha/hand-pointer-regular.svg' %}" alt="Select place">
        <h4>Выберите место на карте</h4>
      </div>

      <div class="align-items-center justify-content-center d-flex" v-if="loading" style="height: 100%;">
        <div class="spinner-grow text-light" style="width: 3rem; height: 3rem;" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <div class="place-description" v-if="selectedPlace">

        <img v-bind:src="selectedPlace.mainPhotoSrc" class="d-block shadow mb-3 rounded" v-bind:alt="selectedPlace.title">
        {% verbatim %}
        <h5 class="mb-3">{{ selectedPlace.title }}</h5>
        {% endverbatim %}
        {% verbatim %}
        <p>{{ selectedPlace.short_description }}</p>
        {% endverbatim %}
        <div v-html="selectedPlace.long_description"></div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.10.1/leaflet-providers.min.js" integrity="sha256-EV/ywRtxUOBICwOsLtPpYEONoBF6g+ShAcLX1Ts48GA=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-control-custom@1.0.0/Leaflet.Control.Custom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/loglevel/1.6.8/loglevel.min.js" integrity="sha256-O/iFn3B3kEV/q5PPVW8TVpRhoywaK7NN4UjdnBO9DXo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js" integrity="sha256-ngFW3UnAN0Tnm76mDuu7uUtYEcG3G5H1+zioJw3t+68=" crossorigin="anonymous"></script>

  <script src="{% static 'afisha/leaflet-sidebar.js' %}"></script>

  <script>
    var map = L.map('map');
    map.setView([55.753989, 37.623191], 11);

    L.tileLayer.provider('OpenStreetMap.Mapnik').addTo(map);

    var sidebar = L.control.sidebar('sidebar', {
      closeButton: true,
      position: 'right'
    });
    map.addControl(sidebar);

    sidebar.show();

    // FIXME should be hidden in production mode
    L.control.custom({
      position: 'bottomleft',
      content: `
        <label>
            <input name="debug" type="checkbox" ${log.getLevel()<=1 && 'checked'}/>
            Отладка
        </label>`,
      style: {
        padding: '10px',
        background: 'rgba(255, 255, 255, 0.7)',
      },
      events: {
        click: event => {
          if (event.target.name == 'debug'){
            let level = event.target.checked && 'debug' || 'warn';
            log.setLevel(level);
            console.log(`Set log level: ${level}`)
          }
        },
      }
    }).addTo(map);

    function loadJSON(elementId){
      let element = document.getElementById(elementId);

      if (!element){
        log.error(`Not found element with id '${elementId}'.`)
        return null;
      }

      return JSON.parse(element.textContent);
    }

    let places = loadJSON('places-geojson');
    log.debug('Load GeoJSON for places', places);

    L.geoJSON(places, {
        // style: function (feature) {
        //     return {color: feature.properties.color};
        // }
    }).bindPopup(function (layer) {
        return layer.feature.properties.title;
    }).on('click', function(event){
      let feature = event.sourceTarget.feature;
      if (feature.geometry.type != "Point"){
        return
      }

      log.debug('Feature selected', feature);
      sidebar.show();
      loadPlaceInfo(feature.properties.placeId, feature.properties.detailsUrl);
    }).addTo(map);

    var sidebarApp = new Vue({
      el: '#sidebar-app',
      data: {
        loadingPlaceId: null,
        selectedPlace: null,  // object with attributes specified below
          // title
          // placeId
          // mainPhotoSrc
          // imgs
          // short_description
          // long_description
      },
      computed: {
        promptVisible: function () {
          return !this.loading && !this.selectedPlace;
        },
        loading: function () {
          return this.loadingPlaceId !== null;
        },
      }
    });

    map.on('click', function () {
      sidebarApp.selectedPlace = null;
      sidebarApp.loadingPlaceId = null;
    })

    async function loadPlaceInfo(placeId, detailsUrl){
      sidebarApp.selectedPlace = null;
      sidebarApp.loadingPlaceId = placeId;

      try {
        let response = await fetch(detailsUrl);

        if (!response.ok){
          return;
        }

        let data = await response.json();

        if (sidebarApp.loadingPlaceId != placeId){
          // Place loading was cancelled by user
          return
        }

        let mainPhotoSrc = data.imgs.length && data.imgs[0] || null;
        sidebarApp.selectedPlace = {
          title: data.title,
          placeId: placeId,
          mainPhotoSrc: mainPhotoSrc,
          imgs: data.imgs,
          short_description: data.description_short,
          long_description: data.description_long,
        };
      } finally {
        if (sidebarApp.loadingPlaceId == placeId){
          sidebarApp.loadingPlaceId = null;
        }
      }
    }
  </script>
</body>
</html>
